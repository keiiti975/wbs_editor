<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>wbs_editor</title>
    <link href="css/main.css" rel="stylesheet" />
    <script type="text/javascript" src="../js/tree/init.js"></script>
</head>

<body>
    <div id="editor_area" style="white-space: nowrap; overflow-x: scroll; padding-bottom: 15px;">
        <div id="d0_area" class="depth_area">
            <div id="d0_name" class="depth_node">目的</div>
            <div id="d0_1" class="task_node">カレーライスを作る</div>
        </div>
        <div id="d1_area" class="depth_area">
            <div id="d1_name" class="depth_node">フェーズ</div>
            <div id="d1_1" class="task_node">カレーを煮込む</div>
        </div>
        <div id="d2_area" class="depth_area">
            <div id="d2_name" class="depth_node">タスク</div>
            <div id="d2_1" class="task_node">ニンジンを切る</div>
            <div id="d2_2" class="task_node">玉ねぎを切る</div>
            <div id="d2_3" class="task_node">ジャガイモを切る</div>
            <div id="d2_4" class="task_node">お米を研ぐ</div>
            <div id="d2_5" class="task_node">お米を水に浸す</div>
            <div id="d2_6" class="task_node">ご飯を炊く</div>
        </div>
    </div>

    <div id="footer_area">
        <a href="#" id="insert_task" class="btn-circle-stitch">+</a>
        <a href="#" id="delete_task" class="btn-circle-stitch">-</a>
    </div>

    <script>
        // for debugging
        const console = require('electron').remote.require('console');
        const electron = require('electron');

        const { ipcRenderer } = electron;

        const editor_area = document.getElementById('editor_area');
        const insert_task_btn = document.getElementById('insert_task');
        const delete_task_btn = document.getElementById('delete_task');

        let selected_elem = null;

        // get mouse position function
        function getMousePos(e) {
            let posx = 0;
            let posy = 0;
            if (!e) e = window.event;
            if (e.pageX || e.pageY) {
                posx = e.pageX;
                posy = e.pageY;
            }
            else if (e.clientX || e.clientY) {
                posx = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
                posy = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
            }
            return { x: posx, y: posy }
        };

        // get clicked element
        editor_area.addEventListener('click', (event) => {
            let json_pos = getMousePos(event);
            let elem_posx = Math.floor(json_pos["x"] / 200);
            let elem_posy = Math.floor(json_pos["y"] / 25);
            let elem = document.getElementById("d" + String(elem_posx) + "_" + String(elem_posy));
            elem.style.backgroundColor = 'yellow';
            if (selected_elem != null) {
                selected_elem.style.backgroundColor = 'white';
            }
            selected_elem = elem;
        });

        // request a input window
        insert_task_btn.addEventListener('click', (event) => {
            ipcRenderer.send('inputWindow:create');
        });

        // insert task
        ipcRenderer.on('inputForm:insert', (event, inputForm) => {
            // console.log(inputForm);
            let selected_id = Number(selected_elem.id.split("_")[1]);
            let child_nodes = selected_elem.parentNode.children;
            Array.prototype.forEach.call(child_nodes, (value) => {
                let value_depth = value.id.split("_")[0];
                let value_id = value.id.split("_")[1];
                if (value_id != "name") {
                    value_id = Number(value_id);
                    if (selected_id <= value_id) {
                        value.id = value_depth + "_" + String(value_id + 1);
                    }
                }
            });
        });

        // delete task
        delete_task_btn.addEventListener('click', (event) => {
            const root = new Tree_Node('Root');

            let groupA = new Tree_Node('GROUP_A');
            let groupB = new Tree_Node('GROUP_B');

            root.addchild(groupA);
            root.addchild(groupB);

            let groupA_1 = new Tree_Node('GROUP_A_1');
            let groupA_2 = new Tree_Node('GROUP_A_2');

            groupA.addchild(groupA_1);
            groupA.addchild(groupA_2);

            console.log(root.countleaf());
        });
    </script>
</body>

</html>